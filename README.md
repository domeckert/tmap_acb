# tmap_acb
Thermodynamic map generation from X-ray multiband images

This is a set of Python scripts that allows the user to generate thermodynamic maps for galaxy clusters and groups from a set of X-ray images in various energy bands. The tool uses the adaptive circular binning (ACB) algorithm to accumulate a target number of photons around each pixel, determine the pseudo-spectrum of the source in the corresponding region and fit it with a spectral template generated using the APEC code implemented in XSPEC.

Running each of the tools without arguments provides a short description of their usage. See also the description below.

The Python code depends on numpy, scipy, astropy, and iminuit. XSPEC is also required to generate the templates.

## _templates.py_

Generate template count rates from the APEC model in a set of energy bands

Usage:

    python templates.py -z redshift -n nh -b bands -o outputfile --abund="aspl" --withabund=y/n
    
Parameter description:

- -z _redshift_ : source redshift
- -n _nh_ : Galactic column density in unit of 1e22 cm-2
- -b _"bands"_ : Definition of energy bands of the provided images. This should be an ASCII file with two columns containing the lower and upper boundaries of the energy bands in keV.
- -o _outputfile_ : Name of output file containing spectral templates
- --abund=_"aspl"_ : (optional) Solar abundance table to be used. Defaults to "aspl".
- --withabund=_"y/n"_ : (optional) Set whether the grid of templates should be given as a function of temperature only or also as a function of metallicity. If set to "y", templates will be calculated for a grid of metallicities ranging from 0 to 1.5. Otherwise, a single metallicity of 0.3 is assumed. Defaults to "n".

## _skybkg_spec.py_ 

Compute template count rates from a sky background model. In case the parameters of the sky background model have been estimated previously through bona fide spectral fitting, this tool computes the estimated sky background count rates in each band of interest.

Usage: 

    python skybkg_spec.py -p cxbparfile -b bands -o outputfile --abund="aspl" --uhtp=y/n
    
Parameter description:

- -p _cxbparfile_ : Parameter file containing the values of the sky background parameters per square arcmin. See the file _cxbpars.txt_ as an example. 
- -b _bands_ : Definition of energy bands of the provided images. This should be an ASCII file with two columns containing the lower and upper boundaries of the energy bands in keV.
- -o _outputfile_ : Name of output file containing the sky background template.
- --abund=_"aspl"_ : (optional) Solar abundance table to be used. Defaults to "aspl".
- --uhtp=_"y/n"_ : (optional) Set whether an additional APEC component describing a super-virial emission component to the Galactic halo will be used. Defaults to _"n"_.

## _tmap_acb_abund.py_

Thermodynamic map generation using adaptive circular binning.

Usage: 

    python tmap_acb_abund.py -i imglist -e explist -t template -o outfile --bkgmaps=bkglist --mask=mask.fits --rmax=3 --ncount=200 --countimage=imagelink --tmin=0.5 --regfile=file.reg --skybkg=skybkg.dat

Parameter description:

- -i _imglist_ : ASCII file containing the list of count images (one per line and per energy band). The energy band definition should match that provided to templates.py for the template generation.
- -e _explist_ : File containing the list of exposure maps. The number of files and the order should match the definition of the image list.
- -t _template_ : Template file generated by _templates.py_.
- -o _outfile_ : Name of output file containing the thermodynamic maps
- --bkgmaps=_bkglist_ : (optional) File containing a list of non X-ray background maps. If this is not provided, the non X-ray background is neglected.
- --mask=_mask.fits_ : (optional) Mask file containing the definition of the regions where the temperature map will be generated. This should be an image of the same dimension as the provided images containing 0 (neglect) and 1 (include). If not provided, the entire image is used (see also _rmax_)
- --rmax=_3_: : (optional) Maximum radius (in arcmin) out to which the temperature map will be calculated. Defaults to 3.
- --ncount=_200_ : (optional) Target number of counts for the adaptive circular binning algorithm. If _countimage_ is provided, the image link provided with this argument is used for the definition of ACB regions. Otherwise, the first energy band from the list is used. Defaults to 200.
- --countimage=_imagelink_ : (optional) Count map used for the definition of the ACB regions. If this is not provided, the first image in the list is used.
- --tmin=_0.5_ : (optional) Minimum temperature value set for the fitting algorithm. Defaults to 0.5.
- --regfile=_file.reg_ : (optional) Region file containing region definitions to be excluded from the reconstruction (typically point sources).
- --skybkg=_skybkg.dat_ : (optional) Template file containing the model sky background count rate per band. This can be generated by the _skybkg_spec.py_ tool. If this is not provided, the region located outside of rmax is used to estimate on-the-fly the local sky background (not recommended). 
